import React, { useState, useEffect, useCallback } from 'react';
import { ComposedChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Scatter } from 'recharts';
import { ChevronDown, ChevronUp, RefreshCcw } from 'lucide-react';

// Recharts 및 Lucide React 아이콘은 이미 사용 가능하다고 가정합니다.
// <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
// <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.292.0/dist/umd/lucide-react.min.js"></script>

const App = () => {
  const [managers, setManagers] = useState([]);
  const [selectedManager, setSelectedManager] = useState('');
  const [employees, setEmployees] = useState([]);
  const [selectedEmployeeName, setSelectedEmployeeName] = useState('');
  const [feedbackData, setFeedbackData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // 구글 시트 URL의 ID를 여기에 입력하세요.
  // 이 ID는 URL에서 "1eLu20DK7IXBSz_XnrChI5Pc0rIeaxgDXdaTOfz5LqhI" 와 같이 'd/'와 '/edit' 사이에 있는 문자열입니다.
  const SHEET_ID = '1eLu20DK7IXBSz_XnrChI5Pc0rIeaxgDXdaTOfz5LqhI';
  const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const fetchData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch(GOOGLE_SHEET_URL);
      if (!response.ok) {
        throw new Error('네트워크 응답이 올바르지 않습니다.');
      }
      const text = await response.text();
      const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonText);
      
      const rows = data.table.rows;
      const columns = data.table.cols;
      
      // 제공해주신 헤더 이름에 맞게 수정
      const COLUMN_HEADERS = {
        manager: '매니저명',
        name: '사원명',
        summary: '총평',
        feedbackItems: [
          { item: '제품특징', score: '제품특징 점수', basis: '제품특징 점수 근거', improvement: '제품특징 개선점' },
          { item: '제품사용설명', score: '제품사용설명 점수', basis: '제품사용설명 점수 근거', improvement: '제품사용설명 개선점' },
          { item: '묶음판매', score: '묶음판매 점수', basis: '묶음판매 점수 근거', improvement: '묶음판매 개선점' },
          { item: '친절', score: '친절 점수', basis: '친절 점수 근거', improvement: '친절 개선점' },
          { item: '자신감', score: '자신감 점수', basis: '자신감 점수 근거', improvement: '자신감 개선점' },
          { item: '고객소통', score: '고객소통 점수', basis: '고객소통 점수 근거', improvement: '고객소통 개선점' },
          { item: '고객 니즈 파악', score: '고객 니즈 파악 점수', basis: '고객 니즈 파악 점수 근거', improvement: '고객 니즈 파악 개선점' },
          { item: '개인화된 제품 추천', score: '개인화된 제품 추천 점수', basis: '개인화된 제품 추천 점수 근거', improvement: '개인화된 제품 추천 개선점' },
          { item: '재치 있는 멘트', score: '재치 있는 멘트 점수', basis: '재치 있는 멘트 점수 근거', improvement: '재치 있는 멘트 개선점' },
          { item: '클로징 능력', score: '클로징 능력 점수', basis: '클로징 능력 점수 근거', improvement: '클로징 능력 개선점' },
        ],
      };

      const getColumnIndex = (label) => {
        const col = columns.find(c => c.label === label);
        return col ? columns.indexOf(col) : -1;
      };

      const managerIndex = getColumnIndex(COLUMN_HEADERS.manager);
      const nameIndex = getColumnIndex(COLUMN_HEADERS.name);
      const summaryIndex = getColumnIndex(COLUMN_HEADERS.summary);
      
      const feedbackItemIndices = COLUMN_HEADERS.feedbackItems.map(item => ({
        item: item.item,
        scoreIndex: getColumnIndex(item.score),
        basisIndex: getColumnIndex(item.basis),
        improvementIndex: getColumnIndex(item.improvement)
      }));

      const missingColumns = [];
      if (managerIndex === -1) missingColumns.push(COLUMN_HEADERS.manager);
      if (nameIndex === -1) missingColumns.push(COLUMN_HEADERS.name);
      if (summaryIndex === -1) missingColumns.push(COLUMN_HEADERS.summary);
      feedbackItemIndices.forEach(item => {
        if (item.scoreIndex === -1) missingColumns.push(item.score);
        if (item.basisIndex === -1) missingColumns.push(item.basis);
        if (item.improvementIndex === -1) missingColumns.push(item.improvement);
      });

      if (missingColumns.length > 0) {
        const missingLabels = missingColumns.join(', ');
        throw new Error(`필수 컬럼(${missingLabels})을 찾을 수 없습니다. 구글 시트의 헤더를 확인해주세요.`);
      }

      const groupedData = {};
      const allManagers = new Set();
      rows.forEach(row => {
        const cells = row.c;
        const managerName = cells[managerIndex]?.v || '';
        const employeeName = cells[nameIndex]?.v || '';

        if (managerName && employeeName) {
          allManagers.add(managerName);
          if (!groupedData[managerName]) {
            groupedData[managerName] = {};
          }
          if (!groupedData[managerName][employeeName]) {
            groupedData[managerName][employeeName] = {
              feedbackItems: [],
              summary: cells[summaryIndex]?.v || '',
            };
          }
          feedbackItemIndices.forEach(item => {
            const score = cells[item.scoreIndex]?.v;
            const basis = cells[item.basisIndex]?.v || '';
            const improvement = cells[item.improvementIndex]?.v || '';
            
            if (score !== null) {
              groupedData[managerName][employeeName].feedbackItems.push({
                item: item.item,
                score: score,
                basis: basis,
                improvement: improvement,
              });
            }
          });
        }
      });
      
      setManagers(Array.from(allManagers));
      setFeedbackData(groupedData);
      setLoading(false);
    } catch (err) {
      console.error('데이터를 불러오는 중 오류 발생:', err);
      setError(`데이터를 불러오는 데 실패했습니다: ${err.message}. 구글 시트 URL 및 공개 설정을 확인하거나 컬럼 헤더 이름이 올바른지 확인해주세요.`);
      setLoading(false);
    }
  }, [GOOGLE_SHEET_URL]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  const handleManagerChange = (event) => {
    const newManager = event.target.value;
    setSelectedManager(newManager);
    setSelectedEmployeeName(''); // 매니저가 바뀌면 사원명 초기화
    if (feedbackData[newManager]) {
      setEmployees(Object.keys(feedbackData[newManager]));
    } else {
      setEmployees([]);
    }
  };

  const handleEmployeeChange = (event) => {
    setSelectedEmployeeName(event.target.value);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-gray-100 p-4">
        <div className="text-xl text-gray-700">데이터를 불러오는 중...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-red-100 p-4">
        <div className="text-lg text-red-700 text-center">{error}</div>
      </div>
    );
  }

  const selectedEmployeeData = selectedManager && selectedEmployeeName ? feedbackData[selectedManager][selectedEmployeeName] : null;

  // 전체 직원의 평균 점수를 계산합니다.
  const calculateAggregateData = () => {
    if (!feedbackData) return {};
    const allItemsData = {};
    Object.values(feedbackData).forEach(managerData => {
      Object.values(managerData).forEach(employeeData => {
        employeeData.feedbackItems.forEach(item => {
          if (!allItemsData[item.item]) {
            allItemsData[item.item] = { total: 0, count: 0 };
          }
          allItemsData[item.item].total += item.score;
          allItemsData[item.item].count += 1;
        });
      });
    });

    const aggregateData = {};
    for (const item in allItemsData) {
      aggregateData[item] = {
        avg: allItemsData[item].total / allItemsData[item].count,
      };
    }
    return aggregateData;
  };
  
  const aggregateData = calculateAggregateData();
  
  const chartData = selectedEmployeeData ? selectedEmployeeData.feedbackItems.map(item => ({
    name: item.item,
    // 점수가 이미 10점 만점이라고 가정하고 그대로 사용
    내점수: item.score,
    평균점수: aggregateData[item.item] ? aggregateData[item.item].avg : 0,
  })) : [];

  // 항목 수에 따라 그래프 높이를 동적으로 계산
  const chartHeight = Math.max(300, chartData.length * 40);

  // Recharts Y축에 사용할 커스텀 텍스트 컴포넌트
  const CustomizedYAxisTick = (props) => {
    const { x, y, payload } = props;
    return (
      <g transform={`translate(${x},${y})`}>
        <text x={0} y={0} dy={16} textAnchor="end" fill="#6b7280" fontWeight="bold">
          {payload.value}
        </text>
      </g>
    );
  };

  return (
    <div className="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans antialiased">
      <div className="max-w-lg mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">
            사원 피드백 조회
          </h1>
          <button
            onClick={fetchData}
            className="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors"
          >
            <RefreshCcw size={16} />
            <span>데이터 다시 불러오기</span>
          </button>
        </div>

        {/* 매니저명 선택 드롭다운 */}
        <div className="mb-4">
          <label htmlFor="manager-select" className="block text-gray-700 font-semibold mb-2">
            매니저명 선택
          </label>
          <select
            id="manager-select"
            value={selectedManager}
            onChange={handleManagerChange}
            className="w-full p-3 border border-gray-300 rounded-lg text-gray-700 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option value="" disabled>--- 매니저를 선택하세요 ---</option>
            {managers.map((name) => (
              <option key={name} value={name}>
                {name}
              </option>
            ))}
          </select>
        </div>

        {/* 사원명 선택 드롭다운 (매니저 선택 후 활성화) */}
        <div className="mb-8">
          <label htmlFor="employee-select" className="block text-gray-700 font-semibold mb-2">
            사원명 선택
          </label>
          <select
            id="employee-select"
            value={selectedEmployeeName}
            onChange={handleEmployeeChange}
            disabled={!selectedManager}
            className={`w-full p-3 border border-gray-300 rounded-lg text-gray-700 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all ${!selectedManager ? 'opacity-50 cursor-not-allowed' : ''}`}
          >
            <option value="" disabled>--- 사원명을 선택하세요 ---</option>
            {employees.map((name) => (
              <option key={name} value={name}>
                {name}
              </option>
            ))}
          </select>
        </div>

        {selectedEmployeeName && selectedEmployeeData && (
          <div>
            <div className="text-center mb-6">
              <h2 className="text-2xl font-bold text-gray-800">
                {selectedEmployeeName}님의 피드백
              </h2>
            </div>
            
            <div className="bg-blue-50 p-4 rounded-xl shadow-inner mb-8">
              <h3 className="text-xl font-semibold text-gray-700 mb-4">평가 항목별 점수</h3>
              <ResponsiveContainer width="100%" height={chartHeight}>
                <ComposedChart layout="vertical" data={chartData} margin={{ top: 5, right: 30, left: 160, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis type="number" domain={[0, 10]} tickCount={11} interval={0} stroke="#6b7280" />
                  <YAxis type="category" dataKey="name" stroke="#6b7280" tick={<CustomizedYAxisTick />} />
                  <Tooltip 
                    formatter={(value, name) => {
                        if (name === '내점수') return [`내 점수: ${value}`];
                        if (name === '평균점수') return [`평균 점수: ${value.toFixed(1)}`];
                        return [value];
                    }} 
                  />
                  <Bar dataKey="내점수" fill="#88d8b0" barSize={20} radius={[0, 10, 10, 0]} />
                  <Scatter name="평균 점수" dataKey="평균점수" fill="#ff6699" />
                </ComposedChart>
              </ResponsiveContainer>
              <div className="flex justify-center mt-4 space-x-4">
                <div className="flex items-center">
                  <span className="w-4 h-4 bg-[#ff6699] rounded-full mr-2"></span>
                  <span>평균 점수</span>
                </div>
                <div className="flex items-center">
                  <div className="w-8 h-4 bg-[#88d8b0] rounded-md mr-2"></div>
                  <span>내 점수</span>
                </div>
              </div>
            </div>
            
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-gray-700 mb-4">종합 피드백</h3>
              <div className="space-y-4">
                {selectedEmployeeData.feedbackItems.map((item, index) => {
                  const isAboveAverage = item.score > (aggregateData[item.item]?.avg || 0);
                  return (
                    <CollapsibleCard
                      key={index}
                      title={item.item}
                      basis={item.basis}
                      improvement={item.improvement}
                      isAboveAverage={isAboveAverage}
                    />
                  );
                })}
              </div>
            </div>

            <div className="bg-green-50 p-6 rounded-xl shadow-inner border-l-4 border-green-400">
              <h3 className="text-xl font-semibold text-gray-700 mb-2">총평</h3>
              <p className="text-gray-600 leading-relaxed">
                {selectedEmployeeData.summary}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const CollapsibleCard = ({ title, basis, improvement, isAboveAverage }) => {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
      <div
        className="flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center space-x-2">
          <span className="font-semibold text-gray-800 whitespace-nowrap overflow-hidden truncate">
            {title}
          </span>
          {isAboveAverage && (
            <span role="img" aria-label="thumbs up" className="text-lg">
              👍
            </span>
          )}
        </div>
        {isOpen ? <ChevronUp className="h-5 w-5 text-gray-500" /> : <ChevronDown className="h-5 w-5 text-gray-500" />}
      </div>
      <div
        className={`bg-white p-4 transition-all duration-300 ease-in-out ${
          isOpen ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0 overflow-hidden'
        }`}
      >
        <p className="text-gray-600 mb-2">
          <strong className="text-blue-600">평가 근거:</strong> {basis}
        </p>
        <p className="text-gray-600">
          <strong className="text-red-600">개선할 점:</strong> {improvement}
        </p>
      </div>
    </div>
  );
};

export default App;
