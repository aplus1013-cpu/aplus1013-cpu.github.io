import React, { useState, useEffect, useCallback } from 'react';
import { ComposedChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Scatter } from 'recharts';
import { ChevronDown, ChevronUp, RefreshCcw } from 'lucide-react';

// Recharts ë° Lucide React ì•„ì´ì½˜ì€ ì´ë¯¸ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
// <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
// <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.292.0/dist/umd/lucide-react.min.js"></script>

const App = () => {
  const [managers, setManagers] = useState([]);
  const [selectedManager, setSelectedManager] = useState('');
  const [employees, setEmployees] = useState([]);
  const [selectedEmployeeName, setSelectedEmployeeName] = useState('');
  const [feedbackData, setFeedbackData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // êµ¬ê¸€ ì‹œíŠ¸ URLì˜ IDë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
  // ì´ IDëŠ” URLì—ì„œ "1eLu20DK7IXBSz_XnrChI5Pc0rIeaxgDXdaTOfz5LqhI" ì™€ ê°™ì´ 'd/'ì™€ '/edit' ì‚¬ì´ì— ìˆëŠ” ë¬¸ìì—´ì…ë‹ˆë‹¤.
  const SHEET_ID = '1eLu20DK7IXBSz_XnrChI5Pc0rIeaxgDXdaTOfz5LqhI';
  const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const fetchData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch(GOOGLE_SHEET_URL);
      if (!response.ok) {
        throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
      const text = await response.text();
      const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonText);
      
      const rows = data.table.rows;
      const columns = data.table.cols;
      
      // ì œê³µí•´ì£¼ì‹  í—¤ë” ì´ë¦„ì— ë§ê²Œ ìˆ˜ì •
      const COLUMN_HEADERS = {
        manager: 'ë§¤ë‹ˆì €ëª…',
        name: 'ì‚¬ì›ëª…',
        summary: 'ì´í‰',
        feedbackItems: [
          { item: 'ì œí’ˆíŠ¹ì§•', score: 'ì œí’ˆíŠ¹ì§• ì ìˆ˜', basis: 'ì œí’ˆíŠ¹ì§• ì ìˆ˜ ê·¼ê±°', improvement: 'ì œí’ˆíŠ¹ì§• ê°œì„ ì ' },
          { item: 'ì œí’ˆì‚¬ìš©ì„¤ëª…', score: 'ì œí’ˆì‚¬ìš©ì„¤ëª… ì ìˆ˜', basis: 'ì œí’ˆì‚¬ìš©ì„¤ëª… ì ìˆ˜ ê·¼ê±°', improvement: 'ì œí’ˆì‚¬ìš©ì„¤ëª… ê°œì„ ì ' },
          { item: 'ë¬¶ìŒíŒë§¤', score: 'ë¬¶ìŒíŒë§¤ ì ìˆ˜', basis: 'ë¬¶ìŒíŒë§¤ ì ìˆ˜ ê·¼ê±°', improvement: 'ë¬¶ìŒíŒë§¤ ê°œì„ ì ' },
          { item: 'ì¹œì ˆ', score: 'ì¹œì ˆ ì ìˆ˜', basis: 'ì¹œì ˆ ì ìˆ˜ ê·¼ê±°', improvement: 'ì¹œì ˆ ê°œì„ ì ' },
          { item: 'ìì‹ ê°', score: 'ìì‹ ê° ì ìˆ˜', basis: 'ìì‹ ê° ì ìˆ˜ ê·¼ê±°', improvement: 'ìì‹ ê° ê°œì„ ì ' },
          { item: 'ê³ ê°ì†Œí†µ', score: 'ê³ ê°ì†Œí†µ ì ìˆ˜', basis: 'ê³ ê°ì†Œí†µ ì ìˆ˜ ê·¼ê±°', improvement: 'ê³ ê°ì†Œí†µ ê°œì„ ì ' },
          { item: 'ê³ ê° ë‹ˆì¦ˆ íŒŒì•…', score: 'ê³ ê° ë‹ˆì¦ˆ íŒŒì•… ì ìˆ˜', basis: 'ê³ ê° ë‹ˆì¦ˆ íŒŒì•… ì ìˆ˜ ê·¼ê±°', improvement: 'ê³ ê° ë‹ˆì¦ˆ íŒŒì•… ê°œì„ ì ' },
          { item: 'ê°œì¸í™”ëœ ì œí’ˆ ì¶”ì²œ', score: 'ê°œì¸í™”ëœ ì œí’ˆ ì¶”ì²œ ì ìˆ˜', basis: 'ê°œì¸í™”ëœ ì œí’ˆ ì¶”ì²œ ì ìˆ˜ ê·¼ê±°', improvement: 'ê°œì¸í™”ëœ ì œí’ˆ ì¶”ì²œ ê°œì„ ì ' },
          { item: 'ì¬ì¹˜ ìˆëŠ” ë©˜íŠ¸', score: 'ì¬ì¹˜ ìˆëŠ” ë©˜íŠ¸ ì ìˆ˜', basis: 'ì¬ì¹˜ ìˆëŠ” ë©˜íŠ¸ ì ìˆ˜ ê·¼ê±°', improvement: 'ì¬ì¹˜ ìˆëŠ” ë©˜íŠ¸ ê°œì„ ì ' },
          { item: 'í´ë¡œì§• ëŠ¥ë ¥', score: 'í´ë¡œì§• ëŠ¥ë ¥ ì ìˆ˜', basis: 'í´ë¡œì§• ëŠ¥ë ¥ ì ìˆ˜ ê·¼ê±°', improvement: 'í´ë¡œì§• ëŠ¥ë ¥ ê°œì„ ì ' },
        ],
      };

      const getColumnIndex = (label) => {
        const col = columns.find(c => c.label === label);
        return col ? columns.indexOf(col) : -1;
      };

      const managerIndex = getColumnIndex(COLUMN_HEADERS.manager);
      const nameIndex = getColumnIndex(COLUMN_HEADERS.name);
      const summaryIndex = getColumnIndex(COLUMN_HEADERS.summary);
      
      const feedbackItemIndices = COLUMN_HEADERS.feedbackItems.map(item => ({
        item: item.item,
        scoreIndex: getColumnIndex(item.score),
        basisIndex: getColumnIndex(item.basis),
        improvementIndex: getColumnIndex(item.improvement)
      }));

      const missingColumns = [];
      if (managerIndex === -1) missingColumns.push(COLUMN_HEADERS.manager);
      if (nameIndex === -1) missingColumns.push(COLUMN_HEADERS.name);
      if (summaryIndex === -1) missingColumns.push(COLUMN_HEADERS.summary);
      feedbackItemIndices.forEach(item => {
        if (item.scoreIndex === -1) missingColumns.push(item.score);
        if (item.basisIndex === -1) missingColumns.push(item.basis);
        if (item.improvementIndex === -1) missingColumns.push(item.improvement);
      });

      if (missingColumns.length > 0) {
        const missingLabels = missingColumns.join(', ');
        throw new Error(`í•„ìˆ˜ ì»¬ëŸ¼(${missingLabels})ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ì˜ í—¤ë”ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
      }

      const groupedData = {};
      const allManagers = new Set();
      rows.forEach(row => {
        const cells = row.c;
        const managerName = cells[managerIndex]?.v || '';
        const employeeName = cells[nameIndex]?.v || '';

        if (managerName && employeeName) {
          allManagers.add(managerName);
          if (!groupedData[managerName]) {
            groupedData[managerName] = {};
          }
          if (!groupedData[managerName][employeeName]) {
            groupedData[managerName][employeeName] = {
              feedbackItems: [],
              summary: cells[summaryIndex]?.v || '',
            };
          }
          feedbackItemIndices.forEach(item => {
            const score = cells[item.scoreIndex]?.v;
            const basis = cells[item.basisIndex]?.v || '';
            const improvement = cells[item.improvementIndex]?.v || '';
            
            if (score !== null) {
              groupedData[managerName][employeeName].feedbackItems.push({
                item: item.item,
                score: score,
                basis: basis,
                improvement: improvement,
              });
            }
          });
        }
      });
      
      setManagers(Array.from(allManagers));
      setFeedbackData(groupedData);
      setLoading(false);
    } catch (err) {
      console.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
      setError(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${err.message}. êµ¬ê¸€ ì‹œíŠ¸ URL ë° ê³µê°œ ì„¤ì •ì„ í™•ì¸í•˜ê±°ë‚˜ ì»¬ëŸ¼ í—¤ë” ì´ë¦„ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
      setLoading(false);
    }
  }, [GOOGLE_SHEET_URL]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  const handleManagerChange = (event) => {
    const newManager = event.target.value;
    setSelectedManager(newManager);
    setSelectedEmployeeName(''); // ë§¤ë‹ˆì €ê°€ ë°”ë€Œë©´ ì‚¬ì›ëª… ì´ˆê¸°í™”
    if (feedbackData[newManager]) {
      setEmployees(Object.keys(feedbackData[newManager]));
    } else {
      setEmployees([]);
    }
  };

  const handleEmployeeChange = (event) => {
    setSelectedEmployeeName(event.target.value);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-gray-100 p-4">
        <div className="text-xl text-gray-700">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-red-100 p-4">
        <div className="text-lg text-red-700 text-center">{error}</div>
      </div>
    );
  }

  const selectedEmployeeData = selectedManager && selectedEmployeeName ? feedbackData[selectedManager][selectedEmployeeName] : null;

  // ì „ì²´ ì§ì›ì˜ í‰ê·  ì ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
  const calculateAggregateData = () => {
    if (!feedbackData) return {};
    const allItemsData = {};
    Object.values(feedbackData).forEach(managerData => {
      Object.values(managerData).forEach(employeeData => {
        employeeData.feedbackItems.forEach(item => {
          if (!allItemsData[item.item]) {
            allItemsData[item.item] = { total: 0, count: 0 };
          }
          allItemsData[item.item].total += item.score;
          allItemsData[item.item].count += 1;
        });
      });
    });

    const aggregateData = {};
    for (const item in allItemsData) {
      aggregateData[item] = {
        avg: allItemsData[item].total / allItemsData[item].count,
      };
    }
    return aggregateData;
  };
  
  const aggregateData = calculateAggregateData();
  
  const chartData = selectedEmployeeData ? selectedEmployeeData.feedbackItems.map(item => ({
    name: item.item,
    // ì ìˆ˜ê°€ ì´ë¯¸ 10ì  ë§Œì ì´ë¼ê³  ê°€ì •í•˜ê³  ê·¸ëŒ€ë¡œ ì‚¬ìš©
    ë‚´ì ìˆ˜: item.score,
    í‰ê· ì ìˆ˜: aggregateData[item.item] ? aggregateData[item.item].avg : 0,
  })) : [];

  // í•­ëª© ìˆ˜ì— ë”°ë¼ ê·¸ë˜í”„ ë†’ì´ë¥¼ ë™ì ìœ¼ë¡œ ê³„ì‚°
  const chartHeight = Math.max(300, chartData.length * 40);

  // Recharts Yì¶•ì— ì‚¬ìš©í•  ì»¤ìŠ¤í…€ í…ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸
  const CustomizedYAxisTick = (props) => {
    const { x, y, payload } = props;
    return (
      <g transform={`translate(${x},${y})`}>
        <text x={0} y={0} dy={16} textAnchor="end" fill="#6b7280" fontWeight="bold">
          {payload.value}
        </text>
      </g>
    );
  };

  return (
    <div className="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans antialiased">
      <div className="max-w-lg mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">
            ì‚¬ì› í”¼ë“œë°± ì¡°íšŒ
          </h1>
          <button
            onClick={fetchData}
            className="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors"
          >
            <RefreshCcw size={16} />
            <span>ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</span>
          </button>
        </div>

        {/* ë§¤ë‹ˆì €ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´ */}
        <div className="mb-4">
          <label htmlFor="manager-select" className="block text-gray-700 font-semibold mb-2">
            ë§¤ë‹ˆì €ëª… ì„ íƒ
          </label>
          <select
            id="manager-select"
            value={selectedManager}
            onChange={handleManagerChange}
            className="w-full p-3 border border-gray-300 rounded-lg text-gray-700 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option value="" disabled>--- ë§¤ë‹ˆì €ë¥¼ ì„ íƒí•˜ì„¸ìš” ---</option>
            {managers.map((name) => (
              <option key={name} value={name}>
                {name}
              </option>
            ))}
          </select>
        </div>

        {/* ì‚¬ì›ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´ (ë§¤ë‹ˆì € ì„ íƒ í›„ í™œì„±í™”) */}
        <div className="mb-8">
          <label htmlFor="employee-select" className="block text-gray-700 font-semibold mb-2">
            ì‚¬ì›ëª… ì„ íƒ
          </label>
          <select
            id="employee-select"
            value={selectedEmployeeName}
            onChange={handleEmployeeChange}
            disabled={!selectedManager}
            className={`w-full p-3 border border-gray-300 rounded-lg text-gray-700 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all ${!selectedManager ? 'opacity-50 cursor-not-allowed' : ''}`}
          >
            <option value="" disabled>--- ì‚¬ì›ëª…ì„ ì„ íƒí•˜ì„¸ìš” ---</option>
            {employees.map((name) => (
              <option key={name} value={name}>
                {name}
              </option>
            ))}
          </select>
        </div>

        {selectedEmployeeName && selectedEmployeeData && (
          <div>
            <div className="text-center mb-6">
              <h2 className="text-2xl font-bold text-gray-800">
                {selectedEmployeeName}ë‹˜ì˜ í”¼ë“œë°±
              </h2>
            </div>
            
            <div className="bg-blue-50 p-4 rounded-xl shadow-inner mb-8">
              <h3 className="text-xl font-semibold text-gray-700 mb-4">í‰ê°€ í•­ëª©ë³„ ì ìˆ˜</h3>
              <ResponsiveContainer width="100%" height={chartHeight}>
                <ComposedChart layout="vertical" data={chartData} margin={{ top: 5, right: 30, left: 160, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis type="number" domain={[0, 10]} tickCount={11} interval={0} stroke="#6b7280" />
                  <YAxis type="category" dataKey="name" stroke="#6b7280" tick={<CustomizedYAxisTick />} />
                  <Tooltip 
                    formatter={(value, name) => {
                        if (name === 'ë‚´ì ìˆ˜') return [`ë‚´ ì ìˆ˜: ${value}`];
                        if (name === 'í‰ê· ì ìˆ˜') return [`í‰ê·  ì ìˆ˜: ${value.toFixed(1)}`];
                        return [value];
                    }} 
                  />
                  <Bar dataKey="ë‚´ì ìˆ˜" fill="#88d8b0" barSize={20} radius={[0, 10, 10, 0]} />
                  <Scatter name="í‰ê·  ì ìˆ˜" dataKey="í‰ê· ì ìˆ˜" fill="#ff6699" />
                </ComposedChart>
              </ResponsiveContainer>
              <div className="flex justify-center mt-4 space-x-4">
                <div className="flex items-center">
                  <span className="w-4 h-4 bg-[#ff6699] rounded-full mr-2"></span>
                  <span>í‰ê·  ì ìˆ˜</span>
                </div>
                <div className="flex items-center">
                  <div className="w-8 h-4 bg-[#88d8b0] rounded-md mr-2"></div>
                  <span>ë‚´ ì ìˆ˜</span>
                </div>
              </div>
            </div>
            
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-gray-700 mb-4">ì¢…í•© í”¼ë“œë°±</h3>
              <div className="space-y-4">
                {selectedEmployeeData.feedbackItems.map((item, index) => {
                  const isAboveAverage = item.score > (aggregateData[item.item]?.avg || 0);
                  return (
                    <CollapsibleCard
                      key={index}
                      title={item.item}
                      basis={item.basis}
                      improvement={item.improvement}
                      isAboveAverage={isAboveAverage}
                    />
                  );
                })}
              </div>
            </div>

            <div className="bg-green-50 p-6 rounded-xl shadow-inner border-l-4 border-green-400">
              <h3 className="text-xl font-semibold text-gray-700 mb-2">ì´í‰</h3>
              <p className="text-gray-600 leading-relaxed">
                {selectedEmployeeData.summary}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const CollapsibleCard = ({ title, basis, improvement, isAboveAverage }) => {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
      <div
        className="flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center space-x-2">
          <span className="font-semibold text-gray-800 whitespace-nowrap overflow-hidden truncate">
            {title}
          </span>
          {isAboveAverage && (
            <span role="img" aria-label="thumbs up" className="text-lg">
              ğŸ‘
            </span>
          )}
        </div>
        {isOpen ? <ChevronUp className="h-5 w-5 text-gray-500" /> : <ChevronDown className="h-5 w-5 text-gray-500" />}
      </div>
      <div
        className={`bg-white p-4 transition-all duration-300 ease-in-out ${
          isOpen ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0 overflow-hidden'
        }`}
      >
        <p className="text-gray-600 mb-2">
          <strong className="text-blue-600">í‰ê°€ ê·¼ê±°:</strong> {basis}
        </p>
        <p className="text-gray-600">
          <strong className="text-red-600">ê°œì„ í•  ì :</strong> {improvement}
        </p>
      </div>
    </div>
  );
};

export default App;
